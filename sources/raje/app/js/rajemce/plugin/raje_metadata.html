<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body {
      padding: 20px
    }

    .row {
      margin-top: 10px;
      margin-bottom: 10px
    }

    #txtTitle {
      font-size: 300%;
      height: auto;
      font-weight: 500;
      color: black
    }
  </style>

  <link rel="stylesheet" href="../../../css/bootstrap.min.css">

  <script src="../../../node_modules/tinymce/tinymce.min.js">
  </script>

</head>

<body>
  <div class="container-fluid">

    <h3>Title</h3>

    <div class="row">
      <div class="col-sm-12">
        <input type="text" class="form-control" id="txtTitle" placeholder="Title">
      </div>
    </div>

    <div class="row">
      <div class="col-sm-12">
        <label for="txtSubtitle">Subtitle</label>
        <input type="text" class="form-control" id="txtSubtitle" placeholder="Left empty for no subtitle">
      </div>
    </div>
  </div>

  <script type="text/javascript" src="../../jquery.min.js">
  </script>
  <script type="text/javascript" src="../../bootstrap.min.js">
  </script>

  <script type="text/javascript">
    $(document).ready(function () {
      var args = top.tinymce.activeEditor.windowManager.getParams()

      $('#txtTitle').val(args.title)
      $('#txtSubtitle').val(args.subtitle)

      let container = $('div.container-fluid')

      if (args.authors.length) {

        container.append('<hr><h3>Authors</h3>')
        addAuthors(args.authors)
        container.append('<hr>')
      }

      function addAuthors(authors) {

        // Add all authors
        authors.forEach(function (author) {

          // Single author must have name and email
          let htmlAuthor = $(
            `<div id="author">
              <div class="row">
                <div class="col-sm-6">
                  <label for="txtSubtitle">Name</label>
                  <input type="text" class="form-control" id="txtAuthorName" value="${author.name}">
                </div>
                <div class="col-sm-6">
                  <label for="txtSubtitle">Email</label>
                  <input type="text" class="form-control" id="txtAuthorEmail" value="${author.email}">
                </div>
              </div>
            </div>`
          )

          // Add affiliation title in any case (even if he doesn't have anyone)
          htmlAuthor.append(
            '<div class="row"><div class="col-sm-12"><label for="txtSubtitle">Affiliations</label></div></div>'
          )

          // Add any single affiliation
          author.affiliations.forEach(function (affiliation) {
            htmlAuthor.append(
              `<div class="row">
                <div class="col-sm-12">
                  <div class="input-group">
                    <input type="text" class="form-control txtAuthorAffiliation" value="${affiliation}">
                    <span class="input-group-btn">
                      <button class="btn btn-danger" type="button" id="btnRemoveAffiliation"><span aria-hidden="true">&times;</span></button>
                    </span>
                  </div>
                </div>
              </div>`
            )
          })

          // Last button append affiliation
          htmlAuthor.append(
            `<div class="row">
                <div class="col-sm-12">
                  <button type="button" class="btn btn-default" id="btnAddAffiliation">Add affiliation</button>
                </div>
              </div>`
          )

          // Append single author
          $('div.container-fluid').append(htmlAuthor)
        })

        // Events for any author
        // Remove affiliation by clicking on the red crossed button
        $('div#author').on('click', 'button.btn.btn-danger#btnRemoveAffiliation', function (e) {
          $(this).parents('.row').first().remove()
        })

        // Add new affiliation event
        $('#btnAddAffiliation').on('click', function () {
          $(this).parents('.row').first().before(
            `<div class="row">
                <div class="col-sm-12">
                  <div class="input-group">
                    <input type="text" class="form-control txtAuthorAffiliation">
                    <span class="input-group-btn">
                      <button class="btn btn-danger" type="button" id="btnRemoveAffiliation"><span aria-hidden="true">&times;</span></button>
                    </span>
                  </div>
                </div>
              </div>`
          )
        })
      }

      function getMetadata() {

        let getAuthors = function() {
          let authors = []
          $('div#author').each(function(){
            let author = {
              name: $(this).find('#txtAuthorName').val(),
              email: $(this).find('#txtAuthorEmail').val(),
              affiliations: []
            }
            
            if($(this).find('.txtAuthorAffiliation').length) {

              console.log($(this).find('.txtAuthorAffiliation'))

              $(this).find('.txtAuthorAffiliation').each(function(){
                author.affiliations.push($(this).val())
              })
            }
            authors.push(author)
          })
          return authors
        }

        return {
          subtitle: $('#txtSubtitle').val(),
          title: $('#txtTitle').val(),
          authors: getAuthors()
        }
      }

      // Append submit button
      container.append(
        `<div class="row">
          <div class="col-sm-12">
            <button type="button" class="btn btn-primary" id="btnSubmit">Update metadata</button>
          </div>
        </div>`
      )

      $('#btnSubmit').on('click', function (e) {

        window.parent.tinyMCE.get('raje_root').updated_metadata = getMetadata()
        window.parent.tinyMCE.activeEditor.windowManager.close()
      })
    })
  </script>
</body>

</html>